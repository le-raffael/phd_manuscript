\chapter{Electromagnetic effects in the SOLEDGE3X framework}
\label{chap:SOLEDGE3X_framework}

In the previous chapter, we laid the foundations of drift-reduced models for edge plasma. The project SOLEDGE3X was born with the merge of the 3D turbulence code TOKAM3X\cite{tamain2016tokam3x} and the 2D transport code SolEdge2D\cite{Bufferand_2015}. It stands as a comprehensive multi-species 2D/3D fluid solver to investigate transport and turbulence at the plasma edge up to the first wall, with a particular focus on modeling plasma-wall interactions. This has allowed successful investigations of numerous facets of edge plasma dynamics, such as turbulence\cite{Bufferand_2021} impurity transport\cite{Ciraolo2021} or ITER first-wall fluxes\cite{Rivals2022}. Until now, however, the model has been limited to electrostatic turbulence, with only fluctuations in the electric potential, determined by the non-adiabatic response to density fluctuations, being taken into account. \\

By the end of this chapter, we will have formulated a set of self-consistent transport equations that include electromagnetic effects. The existing SOLEDGE3X framework is extended to accomodate a finite electron mass in Ohm's law, an inductive term in the parallel electric field and flutter perturbations of the magnetic equilibrium. This requires the addition of two new fields: the parallel current density $j_\parallel$ and the parallel magnetic vector potential $A_\parallel$. \\

In the first section \ref{sec:S3X_referenceValues}, we introduce reference values for all quantities against which all variables are normalized, including the new electromagnetic fields. Then, section \ref{sec:S3X_TransportEquations} recaps the density, momentum, energy and charge conservation equations and their exact formulation in SOLEDGE3X. The entire section \ref{sec:S3X_electromagneticModel} is dedicated to the electromagnetic model and its formulation within the charge balance equation. Finally, section \ref{sec:S3X_boundaryConditions} describes boundary conditions imposed at the sheath, the core and the first wall.



\section{Dimensionless fields}
\label{sec:S3X_referenceValues}

To simplify the equations and improve the numerical stability, the code solves the equation for dimensionless physical quantities. It means that each variable $X$ is scaled by a factor $X_0$ to obtain a dimensionless $\hat{X} = X/X_0$, where $X_0$ is representative for the range of values of $X$. Therefore, all quantities $\hat{X}$ have similar values and we can prevent some numerical issues that might occur in equations containing variables with strongly different orders of magnitude. \\

The reference density $n_0$, temperature $T_0$ and magnetic field $B_0$ are free parameters that must be specified by the user to best match the conditions of the simulated scenario. Masses are expressed as factors of the atomic unit mass $m_u$ and the Coulomb logarithm for particle collisions is set to $\Lambda = 15$. In the sheath-dominated SOL, the electric potential $\Phi$ is proportional to the temperature with $\Phi_{se} = $ln$\left(\sqrt{m_i/(2\pi m_e})\right)T\approx3T$. The potential is hence of the same order of magnitude as the temperature and it is convenient to set $\Phi_0 = T_0$. In this context, it is important to remember that temperatures are always expressed as energies in units of electronvolts [eV]. From the set of free parameters, we can derive spatial and temporal reference values to match the cyclotronic time $\tau_0$ and the Larmor radius $\rho_0$:
\begin{align}
	\tau_0 &= \frac{m_u}{eB_0} \\
	\rho_0^2 &= \frac{T_0m_u}{eB_0^2} \\
	\rho_0 &= c_0 \tau_0 & \text{with the reference thermal ion speed} c_0 = \sqrt{\frac{eT_0}{m_u}}
\end{align}
In addition, dimensionless versions of the Spitzer-Härm viscosity $\nu_{\parallel,\alpha}$, conductivity $\kappa_{\parallel,\alpha}$ and resistivity $\eta_\parallel$ may be defined:
\begin{align}
	\nu_{\parallel,\alpha}^0 &= \frac{\tau_0}{n_0\rho_0^2m_u}T_0^{2.5} & %2\cdot10^{-7} \frac{\sqrt{m_\alpha}}{Z^4}
	\kappa_{\parallel,\alpha}^0 &= \frac{\tau_0}{en_0\rho_0^2}T_0^{2.5} & %\frac{47}{\sqrt{m_\alpha}}
	\eta_\parallel^0 &= \frac{en_0}{B_0}T_0^{-1.5} %5\cdot 10^{-5}\Lambda
\end{align}

As for all other physical quantities, the newly introduced fields $A_\parallel$ and $j_\parallel$ are replaced by dimensionless quantities in the code. First of all we need to define two constants $A_\parallel^0$ and $j_\parallel^0$ so that the dimensionless quantities $\hat{A}_\parallel$ and $\hat{j}_\parallel$ have about the same magnitude as the existing fields:
\begin{align}
	\hat{j}_\parallel &= j_\parallel / j_\parallel^0 & \hat{A}_\parallel &= A_\parallel / A_\parallel^0
\end{align}
As the main occurrence of $j_\parallel$ is in the vorticity conservation equation \ref{eq:edge_vorticityConservation}, it is wise to normalize $j_\parallel$ to it. An expression for $j_\parallel^0$ can be derived:

\begin{align}
	&&&\hat{\grad}\cdot\left[\frac{m_un_0\Phi_0}{\tau_0B_0^2\rho_0^2}\frac{\hat{m}_\alpha \hat{n}_\alpha}{ \hat{B}^2}\hat{\partial}_t\hat{\grad}_\perp\hat{\Phi}\right] \sim \hat{\grad}\cdot\left[\frac{j_\parallel^0}{\rho_0}\hat{j_\parallel}\mathbf{b}\right] \nonumber \\
	\Rightarrow&&& j_\parallel^0 = \frac{m_un_0\Phi_0}{\tau_0B_0^2\rho_0} = en_0c_0
\end{align}

This reference value is coherent with the definition of the parallel current density as the difference of electron and ion momentum balances. \\

To define $A_\parallel^0$, there are essentially two different possible choices: the first option originates in Ampère's law \ref{eq:edge_AmpereLaw} and compels $A_\parallel^{0(1)}$ to depend on the magnetic permeability $\mu_0$ and the reference parallel current $j_\parallel^0$.

\begin{align}
	\label{eq:FirstOptionApara0}
	\frac{A_\parallel^{0(1)}}{\rho_0^2} &= \mu_0j_\parallel^0 &\Leftrightarrow&& A_\parallel^{0(1)} &= \mu_0en_0c_0\rho_0^2
\end{align}

The second option relies on the revised definition of the parallel electric field in Eq. \ref{eq:edge_EparaElectromagnetic} and states that $\partial_tA_\parallel$ is homogeneous to $\grad\Phi$. This yields:

\begin{align}
	\label{eq:SecondOptionApara0}
	\frac{A_\parallel^{0(2)}}{\tau_0} &= \frac{\Phi_0}{\rho_0} &\Leftrightarrow&& A_\parallel^{0(2)} &= \frac{\Phi_0\tau_0}{\rho_0}
\end{align}

Both variants are valid, and they differ by a factor:
\begin{equation}
	\frac{A_\parallel^{0(1)}}{A_\parallel^{0(2)}} = \beta_0
\end{equation}

where the reference plasma parameter $\beta_0$ is the ratio between reference plasma and magnetic pressures:
 
\begin{equation}
	\beta_0 = \frac{en_0T_0}{B_0^2 / \mu_0}
\end{equation}

$A_\parallel^{0(1)}$ and $A_\parallel^{0(2)}$ are about four orders of magnitude away in the edge. From a numerical point of view, we need both relations, so an occurrence of the parameter $\beta_0$ is inevitable in the dimensionless formulation of the system. The first option, based on Ampère's law, is chosen for the implementation. In the continuation of this chapter, all relations are expressed with the dimensionless fields.

\section{Transport equations}
\label{sec:S3X_TransportEquations}

For simulations of the SOL in SOLEDGE3X, the three fluid moments in Eqs. \ref{eq:ZeroMomentTransportEquation}, \ref{eq:FirstMomentTransportEquation} and \ref{eq:SecondMomentTransportEquation} are used for the ion density and momentum conservation, electron and ion energy conservation, and vorticity conservation equations. In the drift-reduced formulation, to compute the different drifts that compose the velocity $\mathbf{u}$, it is convenient to decompose it into a parallel component $u_\parallel$ along the magnetic field lines $\mathbf{b}$ and orthogonal $\mathbf{u}_\perp$ components. This relationship is given by:

\begin{align}
	\label{eq:RelationPerpParallelVelocity}
	\mathbf{u} &= u_\parallel \mathbf{b} + \mathbf{u}_\perp & \text{with} \quad u_\parallel = \mathbf{u}\cdot\mathbf{b} \quad &\text{and} \quad \mathbf{u}_\perp = \mathbf{b}\cross\mathbf{u}
\end{align}

This decomposition also applies to any other vector field. The perpendicular velocity is calculated with the plasma drifts in Eq. \ref{eq:edge_vPerpDrifts}. Similarly, we define parallel and perpendicular gradient operators as follows:

\begin{align}
	\nabla_\parallel &= \mathbf{b}\cdot\nabla & \nabla_\perp &= \grad - \grad_\parallel
\end{align}

Anomalous perpendicular diffusion is included in all conservation equations via a term $\mathfrak{D}_X^\alpha$:

\begin{equation}
	\mathfrak{D}_X^\alpha = \grad\cdot\left(D\grad_\perp X_\alpha\right)
\end{equation}

Its usage is twofold: for transport simulations, it accounts for the total cross-field transport with a correspondingly larger diffusion coefficient $D$, such that perpendicular drift velocities are not required. In turbulent simulations with self-consistent drifts, $D$ is much smaller but remains finite to capture phenomena at scales below the mesh resolution and to improve numerical stability. A typical value for the diffusion coefficient is $D = 10^{-2}$ m$^2$/s. \\

In general, the code is capable of handling multiple species, with the index $i$ referring to any of the ion species. Further, the index $e$ denotes electrons, and $\alpha$ variables that apply to both electrons and ions. We can now formulate the balance equations that constitute the SOLEDGE3X model.



\subsection{Mass balance}

The mass conservation equation for ions is straight-forward:

\begin{equation}
	\partial_t n_i + \nabla\cdot\left(n_i\mathbf{u}\right) = S_{n,i} - \mathfrak{D}_n^i
\end{equation}

The ion source term $S_{n,i}$ in the mass balance comes from imposed external sources or from recombination and ionization processes after particle collisions with neutrals. 

%\begin{equation}
%	S_{n_\alpha} = n_en_{\alpha-1}\langle\sigma\nu\rangle_{iz}^{\alpha-1} + n_en_{\alpha+1}\langle\sigma\nu\rangle_{rec}^{\alpha+1} - n_en_{\alpha}\langle\sigma\nu\rangle_{iz}^{\alpha} - n_en_{\alpha}\langle\sigma\nu\rangle_{rec}^{\alpha}
%\end{equation}

It is sufficient to solve the mass balance for ions, as the fluid density of electrons can be easily retrieved with the quasi-neutrality assumption:

\begin{equation}
	n_e = \sum_{i}Z_i n_i
\end{equation}

\subsection{Momentum balance}

In the drift-reduced approach, the momentum  conservation equation is primarily solved in parallel direction on $\gamma_i = n_iu_{\parallel,i}$.

\begin{equation}
	m_i\partial_t \gamma_{i} + m_i\grad\cdot\left(\gamma_{\parallel,i}\mathbf{u}\right) = + Z_in_iE_\parallel -\grad_\parallel{p_i} - \mathbf{b}\cdot\grad\cdot\boldsymbol{\Pi}_i + S_{\gamma,i} + R_{\parallel,i} - \mathfrak{D}_\gamma^i
\end{equation}

The source term $S_{\gamma,i}$ is again due to ionization, recombination and radiation processes. Collisions between particles lead to the parallel friction term $R_{\parallel,i}$, which is known from Braginskii's and Zhdanov's closures. The parallel projection of the stress tensor $\mathbf{\Pi_i}$ can be expressed as\cite{braginskii1965transport,zeiler1997nonlinear, helander2005collisional}: 

\begin{align}
	\mathbf{b}\cdot\grad\cdot\boldsymbol{\Pi}_i = \frac{2}{3}\nabla\parallel\pi_\parallel + \pi_\parallel\nabla\cdot\mathbf{b} &&& \text{with: } \pi_\parallel = 3 \nu_\parallel \left( \grad_\parallel u_{\parallel,i} - \boldsymbol{\kappa}\cdot\mathbf{u}_{\perp,i} - \frac{1}{3}\nabla\cdot\mathbf{u} \right)
\end{align}

including the curvature of the magnetic field $\kappa = \mathbf{b}\cdot\grad\mathbf{b}$. In the most simple model, the electron velocity is calculated under full ambipolarity assumption:

\begin{equation}
	\label{eq:S3X_ambipolarity}
	\gamma_{\parallel,e} = \sum_iZ_i\gamma_i
\end{equation}

with more accurate models currently under development. 




\subsection{Energy balance}

The energy conservation equation is solved for both electrons and ions. As already described in Sec. \ref{ssec:desc_energyBalance}, the total energy is the sum of thermal and kinetic energy:

\begin{equation}
	\varepsilon_\alpha = \frac{3}{2} n_\alpha T_\alpha + \frac{1}{2} m_\alpha n_\alpha u_\alpha^2
\end{equation}

where the kinetic contribution is negligible for electrons. The transport equation for energy is then: 

\begin{equation}
	\partial_t \varepsilon_\alpha + \nabla \cdot \left( (\varepsilon_\alpha + p_\alpha)\mathbf{u}_\alpha + \boldsymbol{\Pi}_i\cdot\mathbf{u}_\alpha + q_\alpha \right) = \mathbf{u}_\alpha \cdot \left(Z_\alpha n_\alpha\mathbf{E}_\alpha + \mathbf{R}_\alpha \right) + Q_\alpha + S_{\varepsilon,\alpha} - \mathfrak{D}_\varepsilon^\alpha
\end{equation}

For $q_\alpha$, we currently only consider the parallel heat flux $q_{\parallel,\alpha} = \kappa_{\parallel,\alpha}\grad T_\alpha$ from the Spiter-Härm model. Additional heat fluxes $Q_\alpha$ and sources $S_{\varepsilon,\alpha}$ arise from the fluid closure.



\subsection{Charge balance}

To complete the system, a last equation on the charge balance is needed. This approach is equivalent to the vorticity conservation equation from Eq. \ref{eq:edge_vorticityConservation}. Because of the quasineutrality assumption the volume charge $\rho$ is assumed to be 0 and charge conservation is ensured if the total current divergence is 0.

\begin{equation}
	\grad\cdot\mathbf{j} = 0
\end{equation}

The total current is due to charge transport by plasma species. It is hence calculated as: 

\begin{equation}
	\mathbf{j} = \sum_{\alpha} Z_\alpha n_\alpha \mathbf{u}_\alpha
\end{equation}

As the current is directly linked to the plasma species transport, it is decomposed into the same terms as the velocities in equations \ref{eq:VelPerp0Component} and \ref{eq:VelPerp1Component}. The "E cross B" drift is the same for all species therefore its contribution to the current vanishes with the quasineutrality assumption. 

jDia
jPi
jPolaRS



Neglecting curvature terms, we can derive an expression for the perpendicular polarization current from \autoref{eq:definitionSmallOmega}.
\begin{align}
	\mathbf{j}_{p} =& -\partial_t\boldsymbol{\omega}_s - \sum_{i}Z_i\grad\cdot\left(\mathbf{u}^{(0)}_i\otimes\boldsymbol{\omega}_i\right) \\
	&\text{with:  }\boldsymbol{\omega}_s = \sum_{i}Z_i\boldsymbol{\omega}_i \nonumber
\end{align}


 Only the zero-th order drift velocities from Eq. \ref{eq:VelPerp0Component} contribute to the polarization current. The problem is not solved on $\mathbf{j}$ itself but on the vorticity defined as $\Omega = \grad\cdot\boldsymbol{\omega}_s$ which gives the expression on $\mathbf{j}_p$: 
 
 \begin{equation}
 	\grad\cdot\mathbf{j}_p = -\partial_t\Omega + \grad\cdot\sum_{i}Z_i\grad\cdot\left(\mathbf{u}^{(0)}_i\otimes\boldsymbol{\omega}_i\right) = - \partial_t\Omega
 \end{equation}

The divergence of the total current can then be transformed into a transport equation on the vorticity:

 \begin{align}
 	&& \grad\cdot\mathbf{j} &= 0 \nonumber \\
 	&\Leftrightarrow& -\grad\cdot\mathbf{j_p} &= \grad\cdot\left(j_\parallel\mathbf{b} + \mathbf{j}^* + \mathbf{j}_{\perp,\Pi} + \mathbf{j}_{\pi} \right) \nonumber \\
 	&\Leftrightarrow& \partial_t\Omega &= \grad\cdot\sum_{i}Z_i\grad\cdot\left(\mathbf{u}^{(0)}_i\otimes\boldsymbol{\omega}_i\right) +\grad\cdot\left(j_\parallel\mathbf{b} + \mathbf{j}^* + \mathbf{j}_{\perp,\Pi} + \mathbf{j}_{\pi} \right)
 	\label{eq:TransportEquationVorticity}
 \end{align}
If this equation is combined with \autoref{eq:definitionSmallOmega} we get :
 \begin{align}
 	&& \boldsymbol{\omega}_i =& \frac{m_i}{Z_iB^2}\left(n_i\grad_\perp\Phi + \frac{1}{Z_i}\grad_{\perp}\left(p_i-\frac{\pi_{\parallel,i}}{3}\right)\right) - \frac{m_i}{Z_i^2B^2}\mathbf{S}_{u_{\perp,i}} \nonumber\\
	&\Leftrightarrow& \sum_{i}Z_i\boldsymbol{\omega}_i =& \sum_{i}Z_i\left[\frac{m_i}{Z_i B^2}\left(n_i\grad_\perp\Phi + \frac{1}{Z_i}\grad_{\perp}\left(p_i-\frac{\pi_{\parallel,i}}{3}\right)\right) - \frac{m_i}{Z_i^2B^2}\mathbf{S}_{u_{\perp,i}}\right] \nonumber\\
	&\Leftrightarrow& \Omega =& \grad\cdot\sum_{i}\left[\frac{m_i}{ B^2}\left(n_i\grad_\perp\Phi + \grad_{\perp}\left(p_i-\frac{\pi_{\parallel,i}}{3}\right)\right) - \frac{m_i}{Z_i B^2}\mathbf{S}_{u_{\perp,i}}\right] \nonumber \\
	&\Leftrightarrow& \partial_t\mathbf{\Omega} =& \grad\cdot\left[\frac{m_i n_i}{ B^2}\partial_t\grad_\perp\Phi\right] + \partial_t \Omega_\pi - \mathfrak{D}_\Omega \nonumber \\
	&\Leftrightarrow& \grad\cdot\left[\frac{m_i n_i}{ B^2}\partial_t\grad_\perp\Phi\right]  =&  \grad\cdot\left(j_\parallel\mathbf{b} + \mathbf{j}^* + \mathbf{j}_{\perp,\Pi} + \mathbf{j}_{\pi}\right) - \partial_t \Omega_\pi - \mathfrak{D}_\Omega \label{eq:FirstFormVorticityEquation}
 \end{align}
 
In this calculation we used the Boussinesq approximation and the Einstein summation over the ion index $i$ allows for a more compact expression. Since we express a conservation on the vorticity $\Omega$, we also introduced an anomalous diffusion term $\mathfrak{D}_\Omega$. All pressure terms are regrouped in $\Omega_\pi$:

\begin{equation}
	\Omega_\pi = \grad\cdot\sum_{i}\left(\frac{m_i}{Z_i B^2}\grad_\perp[n_i T_i]\right)
\end{equation}


The parallel current density is calculated from the generalized Ohm's law neglecting the electron mass (for now) and using Spitzer-Härm resistivity $\eta_\parallel$:
 
\begin{align} 
 	\label{eq:DefinitionParallelCurrent}
 	j_\parallel =& \sigma_\parallel \left(E_\parallel + \frac{\grad_\parallel p_e}{n_e} + 0.71\grad_\parallel T_e\right) & \text{with: }&& \sigma_\parallel = 1/\eta_\parallel
 \end{align}

For now, we assume a static magnetic field and define the parallel electric field as the negative gradient of the electrostatic potential in parallel direction $E_\parallel=-\grad_\parallel\Phi$. With the electron pressure $p_e=n_eT_e$, we get:  
 
$$\frac{1}{n_e}\grad_\parallel p_e = T_e\grad_\parallel\log(n_e) + \grad_\parallel T_e$$

If we now inject \autoref{eq:DefinitionParallelCurrent} into he vorticity equation \autoref{eq:FirstFormVorticityEquation}, we obtain: 
 
\begin{equation}
	\label{eq:ElectrostaticVorticityEquation}
	 \grad\cdot\left[\frac{m_i n_i}{ B^2}\partial_t\grad_\perp\Phi\right]  = \grad\cdot\sigma_\parallel \left[-\grad_\parallel\Phi +  T_e\grad_\parallel\log(n_e) + 1.71\grad_\parallel T_e\right]\mathbf{b} + F_\Omega
\end{equation}

where $F_\Omega = \left(\mathbf{j}^* + \mathbf{j}_{\Pi} + \mathbf{j}_{\pi}\right) - \partial_t \Omega_\pi  - \mathfrak{D}_\Omega$ regroups the remaining terms. \\
The vorticity equation gives an relation for the electric potential $\Phi$, required to calculate "ExB" drifts and therefore essential to simulate plasma turbulence. Because of the low resistivity $\eta_\parallel$, this problem is actually numerically hard to solve. Explicit approaches are then strongly constrained by a timestep size of the order of the collision time. Implicit approaches have to handle a numerically difficult problem, with two Laplacian operators, one perpendicular and one parallel, with a high anisotropy because of the unfavorable ratio $\sigma_\parallel B^2 / m_in_i$ between the respective diffusion coefficients. The hardness to solve the system is a major obstacle for turbulent simulations on larger tokamaks because of prohibitive solve times of iterative solvers. Hotter scenarios, as they would occur in fusion-relevant devices, pose an additional problem as $\eta_\parallel\propto T_e^{-1.5}$, resulting in an even poorer numerical condition of the problem. 



\section{Electromagnetic Model in SOLEDGE3X}
\label{sec:S3X_electromagneticModel}

Until now we have expressed the SOLEDGE3X transport equations as they are used in the existing electrostatic version of the code. It lays the framework on which we are now going to build the electromagnetic model. As demonstrated in the previous Sec. \ref{sec:edge_EMeffects}, it consists of three key elements: electron inertia, magnetic induction and flutter. In this section, each of the ingredients will be introduced separately, to clearly identify the impact of each on the vorticity equation. 


\subsection{Electron Inertia}
\label{ssec:ModelElectronInertia}

%As we have seen in ...., the bad condition number of the vorticity equation has its roots in the combined perpendicular and parallel diffusion on the electric potential. One attempt to ameliorate the situation would be to split these terms in a way that their respective discrete operators are not applied on the same unknown in the vorticity matrix. To express the system in such a way, it is convenient to include the parallel current $j_\parallel$ as a separate variable in the system. In the definition of the parallel current density \autoref{eq:DefinitionParallelCurrent}, we omitted the effects of electron inertia in the generalized Ohm's law. Its full expression states:
%$$ 
%j_\parallel = \sigma_\parallel \left(E_\parallel + \frac{\grad_\parallel p_e}{n_ee} + \frac{0.71}{e}\grad_\parallel T_e + \frac{m_e}{e} \pdv{u_{\parallel,e}}{t}\right) 
%$$

The first element to the electromagnetic model is the electron inertia term in the generalized Ohm's law. To properly derive this term, we start with the parallel momentum conservation equations for electrons \ref{eq:derivationEI_electronParaMomenentum} and ions \ref{eq:derivationEI_ionParaMomenentum}.

\begin{align}
	m_e\partial_t \gamma_{e} + m_e\grad\cdot\left(\gamma_{\parallel,e}\mathbf{u}_e\right) =& -n_eE_\parallel -\grad_\parallel{p_e} - \mathbf{b}\cdot\grad\cdot\boldsymbol{\Pi}_e + S_{\gamma,e} + R_{\parallel,e} - m_e\mathfrak{D}_\gamma^e \label{eq:derivationEI_electronParaMomenentum} \\
	m_i\partial_t \gamma_{i} + m_i\grad\cdot\left(\gamma_{\parallel,i}\mathbf{u}_i\right) =& + Z_in_iE_\parallel -\grad_\parallel{p_i} - \mathbf{b}\cdot\grad\cdot\boldsymbol{\Pi}_i + S_{\gamma,i} + R_{\parallel,i} - m_i\mathfrak{D}_\gamma^i \label{eq:derivationEI_ionParaMomenentum}
\end{align}

Next we multiply the equation for the electrons by $-1/m_e$ and the equation for ions $Z_i/m_i$. If we then take the sum over all species (electrons and all ions), we get a conservation equation for the parallel current density $j_\parallel = \sum_{\alpha} Z_\alpha \gamma_{\parallel,\alpha} $ (defining $Z_e = -1$).

\begin{align}
	\label{eq:S3X_differenceGammaeGammai}
	\frac{m_e}{n_e}\partial_t j_\parallel + \frac{m_e}{n_e}\grad\cdot\left(Z_i\gamma_{\parallel,i}\mathbf{u}_i - \gamma_{\parallel,e}\mathbf{u}_e\right) = &  
	\left(1 + \frac{m_e}{m_i}\frac{Z_i^2n_i}{n_e}\right)E_\parallel + \frac{1}{n_e}\grad_\parallel{p_e} - \frac{m_e}{m_i}\frac{Z_i}{n_e}\grad_\parallel{p_i} \nonumber \\ 
	&+ \frac{1}{n_e}\mathbf{b}\cdot\grad\cdot\boldsymbol{\Pi}_e - \frac{m_e}{m_i}\frac{Z_i}{n_e}\mathbf{b}\cdot\grad\cdot\boldsymbol{\Pi}_i - \frac{1}{n_e}S_{\gamma,e} + \frac{m_e}{m_i}\frac{Z_i}{n_e}S_{\gamma,i} \nonumber \\ 
	&+ \frac{1}{n_e}R_{\parallel,e} + \frac{m_e}{m_i}\frac{Z_i}{n_e}R_{\parallel,i} + \frac{m_e}{n_e}\mathfrak{D}_\gamma^e - \frac{m_eZ_i}{n_e}\mathfrak{D}_\gamma^i
\end{align}

Here the sum over ion species is not written explicitly, but every term involving the index $i$ should be seen as a sum over all ions. Braginskii's closure provides a neat expression for the electron friction terms $R_{\parallel,\alpha}$. It involves an Ohmic term, caused by collisions between charged particles that dissipate the current, and a thermoelectric force, where a temperature gradient can create currents. 

\begin{align}
	R_{\parallel,e} = n_e\left[0.71\grad_\parallel T_e - \eta_\parallel j_\parallel\right]
\end{align}

If we neglect all terms involving the electron mass, we exactly recover the electrostatic Ohm law from Eq. \ref{eq:DefinitionParallelCurrent}. The aim of this section is to consider a finite $m_e$, so we keep all terms. To truly obtain a transport equation on the current, we need to reformulate the advection term. There is no effective advection velocity for $j_\parallel$ readily available and the poor ambipolar definition of $\gamma_{\parallel,e}$ is of little help here. We can instead develop this term to obtain a formulation where $j_\parallel$ is advected by the electron velocity:

\begin{align}
	\grad\cdot\left(\sum_i Z_i\gamma_{\parallel,i}\mathbf{u}_i - \gamma_{\parallel,e}\mathbf{u}_e\right) &= \grad\cdot\left(\sum_i Z_i\gamma_{\parallel,i}\left(\mathbf{u}_i-\mathbf{u}_e\right) - j_\parallel\mathbf{u}_e\right)
\end{align}

If we now rewrite Eq. \ref{eq:S3X_differenceGammaeGammai} with the considerations above, we get: 

\begin{equation}
	\label{eq:S3X_OhmLawElectronInertia}
	\frac{m_e}{n_e}\partial_t j_\parallel + \frac{m_e}{n_e}\grad\cdot\left(j_\parallel\mathbf{u}_e\right)  - \frac{m_e}{n_e}\grad\cdot\left(\sum_i Z_i\mathbf{u}_e\right) = E_\parallel + \frac{\grad_\parallel p_e}{n_e} + 0.71\grad_\parallel T_e - \eta_\parallel j_\parallel + \sum_i Z_i \partial_t \gamma_i - \frac{m_e}{n_e}\mathfrak{D}_j^e
\end{equation}

With this transport equation on the parallel current, the anomalous diffusion is also calculated with $j_\parallel$. The term $\sum_i Z_i \partial_t \gamma_i$ contains all other terms in Eq. \ref{eq:S3X_differenceGammaeGammai}, but they do not need to be explicited in the implementation as they are already known from the ion momentum conservation equations. Numerical experiments have proven the necessity to carefully treat all the terms, especially the advection of $j_\parallel$, to avoid numerical instabilities. \\

If we now combine Ohm's with electron inertia with the electrostatic vorticity equation \ref{eq:ElectrostaticVorticityEquation}, we obtain following system:

\begin{equation}
	\label{eq:vorticityEquation_ElectronInertia}
	\begin{cases}
		\grad\cdot\left[\frac{m_i n_i}{ B^2}\partial_t\grad_\perp\Phi\right] - \grad\cdot\left[j_\parallel\mathbf{b}\right]=& F_\Omega \\
		j_\parallel + \frac{\sigma_\parallel m_e}{n_e}\left[\partial_t j_\parallel + \grad\cdot\left(j_\parallel\mathbf{u}_e\right)\right] =& \sigma_\parallel \left(-\grad_\parallel + \frac{\grad_\parallel p_e}{n_e} + 0.71\grad_\parallel T_e \right) \\ 
		& + \frac{\sigma_\parallel m_e}{n_e}\left[\sum_iZ_i\left[\grad\cdot\left(\mathbf{u}_e \right) + \partial_t \gamma_i\right] - \mathfrak{D}_j^e\right]
	\end{cases}
\end{equation}
We now remain with a single perpendicular Laplacian on $\Phi$, whereas the parallel Laplacian appears as a gradient in the equation on $j_\parallel$ succeeded by a divergence. It may be noted that it is not necessary to include electron inertia to split the two anisotropic Laplacians. If we still assume that the electron mass is neglectable, this system essentially takes the form of a Hessenberg index-1 DAE where $j_\parallel$ is the algebraic variable ---cite---. However such systems tend to be numerically hard to solve and one common approach ---cite--- is to replace the zero-side side of the algebraic equation by the time derivative of the algebraic variable with a small coefficient, which effectively transforms the system into a (stiff) ODE. Exactly this has been done in the new formulation of \autoref{eq:vorticityEquation_ElectronInertia} with the further benefit that the $j_\parallel$ has a physical meaning.4


\subsection{Electromagnetic Induction}
In a more general setting, fluctuations in the magnetic field require taking into account the change of the magnetic vector potential $\mathbf{A}$ linked to the magnetic field by $\grad\times\mathbf{A} = \mathbf{B}$. This new quantity appears in the definition of the parallel electric field, which then depends on the change of $A$ over time:
\begin{equation}
	\label{eq:electricField_eq_gradPhi_p_dtA}
	E_\parallel = -\grad_\parallel\Phi - \partial_t A_\parallel 
\end{equation}
This field appears in the definition of the parallel current \ref{eq:DefinitionParallelCurrent}, which in turn is member of the vorticity equation \ref{eq:TransportEquationVorticity}. With the Coulomb gauge, $j_\parallel$ is directly proportional to the perpendicular diffusion of $A_\parallel$: 
\begin{equation}
	\label{eq:DiffA_eq_mu0jPara}
	\Delta_\perp A_\parallel = -\mu_0j_\parallel
\end{equation}
The electric potential $\Phi$ is thus implicitly linked to $j_\parallel$ and $A_\parallel$ and all three unknowns need to be solved in one common system. To summarize, the new set of equations reads:
\begin{align}
	\grad\cdot\left[\frac{m_\alpha n_\alpha}{ B^2}\partial_t\grad_\perp\Phi\right] &= \grad\cdot(j_\parallel\mathbf{b}) - \partial_t \Omega_\pi \label{eq:NewExtendedSystem_VorticityEquation} \\
	j_\parallel &= \sigma_\parallel\left(-\grad_\parallel\Phi - \partial_tA_\parallel + \frac{ T_e}{e}\grad_\parallel\log(n_e) + \frac{1.71}{e}\grad_\parallel T_e\right) \label{eq:NewExtendedSystem_ParallelCurrent} \\
	\Delta_\perp A_\parallel &= -\mu_0j_\parallel \label{eq:NewExtendedSystem_MagneticPotential}
\end{align}

The equation \ref{eq:NewExtendedSystem_ParallelCurrent} on the intermediate variable $j_\parallel$ can be eliminated to obtain a system of equations only on $\Phi$ and $A_\parallel$:
\begin{align}
	\label{eq:vorticityEquation_electromagnetic}
	\begin{cases}
		\grad\cdot\left[\frac{m_\alpha n_\alpha}{ B^2}\partial_t\grad_\perp\Phi\right] &= \grad\cdot\sigma_\parallel\left(-\grad_\parallel\Phi - \partial_tA_\parallel + \frac{T_e}{e}\grad_\parallel\log(n_e) + \frac{1.71}{e}\grad_\parallel T_e\right)\mathbf{b} - \partial_t \Omega_\pi \\
		\qquad\qquad\quad\Delta_\perp A_\parallel& = -\mu_0\sigma_\parallel\left(-\grad_\parallel\Phi - \partial_tA_\parallel + \frac{T_e}{e}\grad_\parallel\log(n_e) + \frac{1.71}{e}\grad_\parallel T_e\right)
	\end{cases}
\end{align}
These equations use Ohm's law without the electron inertia term introduced in \autoref{ssec:ModelElectronInertia}. It is obviously possible to include the temporal change and perpendicular diffusion of $j_\parallel$ in the electromagnetic equations and it is recommended to do so. To allow for maximal flexibility, any combination of $\Phi$ with $A_\parallel$ and/or $j_\parallel$ can be used and we will discuss each of these combinations.






\subsection{Electromagnetic Flutter}

Due to the strong anisotropy in tokamaks, most edge turbulence codes rely on alignment to the magnetic equilibrium (see discussion in Ref.\cite{SCHWANDER_2024}). However, as mentioned in Sec. \ref{geometry}, in the electromagnetic model, small perturbations of $\mathbf{B}_{eq}$ can exist driven by fluctuations of $A_\parallel$ such as $\tilde{\mathbf{B}} = \nabla \times (\tilde{A_\parallel} \mathbf{b})$. Therefore, these fluctuations of $A_\parallel$ have to be estimated and $A_\parallel$ cannot be used directly. Indeed, the diamagnetic current induced by the evolution of the full plasma pressure is balanced by a stationary background parallel current, the Pfirsch-Schlüter current, which induces a stationary part of significant amplitude in $A_\parallel$ through Ampere's law (Eq. \ref{eq:MagneticPotential}). This latter is denoted $A_{\parallel,0}$, and corresponds to the Grad-Shafranov shift due to Pfirsch-Schlüter currents that are accounted for in the parallel current. This shift $A_{\parallel,0}$ is obviously accounted for in $B_{eq}$, and therefore it has to be subtracted from $A_\parallel$ in nonlinear parallel operators. This is done in this work by simply removing the toroidal average as proposed by Ref.\cite{giacomin2022gbs} in the GBS code: \newline

\begin{equation}
	\tilde{A}_\parallel = A_\parallel - \left<A_\parallel\right>_\varphi \label{eq:averagedAParallel}
\end{equation}

Therefore, the flutter is computed as follows: \newline

\begin{equation}
	\nabla \times \left( \mathbf{A}_{\parallel,0} + \tilde{A}_\parallel \mathbf{b}_{eq} \right) = \mathbf{B}_{eq} + \tilde{\mathbf{B}} 
	\label{eq:definitionMagneticFieldWithFlutter}
\end{equation}

This leads to: \newline

\begin{equation}
	\tilde{\mathbf{b}} = - \frac{\mathbf{b}_{eq} \times \nabla \tilde{A}_\parallel}{\norm{\mathbf{B}}} + \frac{\tilde{A}_\parallel \nabla \times \mathbf{b}_{eq}}{\norm{\mathbf{B}}}
	\label{eq:definitionMagneticFieldWithFlutter_1}
\end{equation}

The gradient $\nabla \tilde{A}_\parallel$ scales with the characteristic turbulent length $1/L_\perp$ and the curl $\nabla \times \mathbf{b}$ with the machine dimension $1/a$. Therefore, $\frac{\mathbf{b}_{eq} \times \nabla \tilde{A}_\parallel}{\norm{\mathbf{B}}}$ is the main contributor to the flutter field. \newline

The perturbed magnetic unit field $\tilde{\mathbf{b}}$ is calculated at the beginning of each timestep and added to the equilibrium unit vector $\mathbf{b}_{eq}$. The complete vector $\mathbf{b} = \mathbf{b}_{eq} + \tilde{\mathbf{b}}$ is then used in all parallel advection, gradient, and diffusion terms. Since we base our calculations on plasma fields from the previous timestep, this perturbation can be seen as an additional first-order drift in the equations. \newline

Note that Hager et al. \cite{hager2022} have suggested an additional time-averaged $\left<A_\parallel\right>_{\varphi,t}$ to evaluate fluctuations in the parallel electromagnetic potential, arguing that turbulent structures might appear at the same position on all poloidal planes and should therefore not be removed in the flutter calculation. This approach has been used in recent work in the GRILLIX code \cite{zhang2024}, but was not adopted in the present work, as it was estimated that the gain in accuracy did not compensate for the additional computation and memory costs. \newline




\subsection{Formulation the electromagnetic vorticity system}
\label{sec:S3X_formulationEMsystem}
\subsubsection{Vorticity system with electron inertia}
The generalized Ohm's law with electron inertia \autoref{eq:OhmLaw_with_electronInertia} is dedimensionalized by the reference current density $j_\parallel^0$:
\begin{align*}
j_\parallel^0\hat{j}_\parallel + \frac{j_\parallel^0\sigma_\parallel^0m_e}{n_0\hat{n}e^2\tau_0} \hat{\sigma}_\parallel\left(\hat{\partial}_t\hat{j}_\parallel - \hat{\grad}\cdot\left(\hat{\nu}_e\hat{\grad}_\perp \hat{j}_\parallel\right)\right) =& \frac{\sigma_\parallel^0}{\rho_0}\hat{\sigma}_\parallel \left(-\Phi_0 \hat{\grad}_\parallel\hat{\Phi} + T_0\hat{T}_e\hat{\grad}_\parallel\log(\hat{n}_e) + T_01.71\hat{\grad}_\parallel \hat{T}_e + \frac{\rho_0n_0m_e}{\tau_0e}\hat{D}_{\perp,u_i}\right) \\
\Leftrightarrow\qquad\qquad\qquad
\hat{j}_\parallel + \frac{m_e\hat{\sigma}_\parallel}{m_u\hat{n}} \hat{\partial}_t\hat{j}_\parallel =& \hat{\sigma}_\parallel \left(-\hat{\grad}_\parallel\hat{\Phi} + \hat{T}_e\hat{\grad}_\parallel\log(\hat{n}_e) + 1.71\hat{\grad}_\parallel \hat{T}_e+\frac{m_e}{m_u}\hat{D}_{\perp,u_i}\right)
\end{align*}
	
	The unit mass $m_u$ appears here from the definition of the reference parameters in \autoref{---} from where we easily derive $m_u = eB_0\tau_0$. The factor $m_e / m_u \approx 10^{-4}$ indicates that the impact of the term $\partial_t j_\parallel$ on Ohm's law is relatively small, however it is large enough to affect the solving properties of the vorticity matrix especially when the timestep size is significantly shorter than the cyclotronic time $\tau_0$. The new dedimensionalized vorticity system reads:
	
	
\begin{equation}
\label{eq:vorticityEquation_ElectronInertia_dedimensionalized}
\begin{cases}
\qquad\qquad\qquad \hat{\grad}\cdot\left[\frac{\hat{m}_\alpha \hat{n}_\alpha}{ \hat{B}^2}\hat{\partial}_t\hat{\grad}_\perp\hat{\Phi}\right] - \hat{\grad}\cdot\left[\hat{j}_\parallel \mathbf{b}\right]
&= -\hat{\partial}_t \hat{\Omega}_\pi \\
\hat{j}_\parallel + \frac{m_e\hat{\sigma}_\parallel}{m_u\hat{n}}\left(\hat{\partial}_t\hat{j}_\parallel - \hat{\grad}\cdot\left(\hat{\nu}_e\hat{\grad}_\perp \hat{j}_\parallel\right)\right) + \hat{\sigma}_\parallel\hat{\grad}_\parallel\hat{\Phi} &= \hat{\sigma}_\parallel \left(\hat{T}_e\hat{\grad}_\parallel\log(\hat{n}_e) + 0.71\hat{\grad}_\parallel \hat{T}_e + \frac{m_e}{m_u}\hat{D}_{\perp,u_i}\right)
\end{cases}
\end{equation}

For better readability this system can be expressed in matrix form, where $\circ$ shall be replaced by the corresponding field within operators.
\begin{equation}
\label{eq:vorticityEquation_ElectronInertia_dedimensionalized_matrix}
\renewcommand\arraystretch{1.8}
\begin{pmatrix}
\hat{\grad}\cdot\left[\frac{\hat{m}_\alpha \hat{n}_\alpha}{ \hat{B}^2}\hat{\partial}_t\hat{\grad}_\perp\circ\right] & 
- \hat{\grad}\cdot\left[\circ\mathbf{b}\right] \\
\hat{\sigma}_\parallel\hat{\grad}_\parallel\circ &
1 + \frac{m_e\hat{\sigma}_\parallel}{m_u\hat{n}}\left(\hat{\partial}_t\circ - \hat{\grad}\cdot\hat{\nu}_e\hat{\grad}_\perp\circ\right)
\end{pmatrix}
\begin{pmatrix}
\hat{\Phi} \\ \hat{j}_\parallel 
\end{pmatrix} = 
\begin{pmatrix}
-\hat{\partial}_t \hat{\Omega}_\pi \\
\hat{\sigma}_\parallel \left(\hat{T}_e\hat{\grad}_\parallel\log(\hat{n}_e) + 0.71\hat{\grad}_\parallel \hat{T}_e + \frac{m_e}{m_u}\hat{D}_{\perp,u_i}\right)
\end{pmatrix}
\end{equation}



\subsubsection{Electromagnetic vorticity system}
The second line of the system in \autoref{eq:vorticityEquation_electromagnetic} might be dedimensionalized as follows:
\begin{align}
&&\hat{\grad}\cdot\left[\frac{A_\parallel^0}{\rho_0^2}\hat{\grad}_\perp \hat{A}_\parallel\right]
&= -\mu_0\sigma_\parallel^0\hat{\sigma}_\parallel\left(
- \frac{\Phi_0}{\rho_0}\hat{\grad}_\parallel\hat{\Phi}
- \frac{A_\parallel^0}{\tau_0}\hat{\partial}_t\hat{A}_\parallel
+ \frac{T_0\hat{T}_e}{e\rho_0}\hat{\grad}_\parallel\log(\hat{n}_e) 
+ \frac{1.71T_0}{e\rho_0}\hat{\grad}_\parallel \hat{T}_e\right) \nonumber \\
%		&\Leftrightarrow&
%		\hat{\grad}\cdot\left[\frac{\mu_0en_0c_0\rho_0^2}{\rho_0^2}\hat{\grad}_\perp \hat{A}_\parallel\right]
%		&= -\mu_0\sigma_\parallel^0\hat{\sigma}_\parallel\left(
%		- \frac{\Phi_0}{\rho_0}\hat{\grad}_\parallel\hat{\Phi}
%		- \frac{A_\parallel^0}{\tau_0}\hat{\partial}_t\hat{A}_\parallel
%		+ \frac{p_0}{\rho_0en_0\hat{n}_e}\hat{\grad}_\parallel \hat{p}_e 
%		+ \frac{0.71T_0}{e\rho_0}\hat{\grad}_\parallel \hat{T}_e\right) \nonumber \\
%		&\Leftrightarrow&
%		\hat{\grad}\cdot\left[en_0c_0\hat{\grad}_\perp \hat{A}_\parallel\right]
%		&= \frac{en_0}{B_0}\hat{\sigma}_\parallel\left(
%		  \frac{\Phi_0}{\rho_0}\hat{\grad}_\parallel\hat{\Phi}
%		+ \frac{A_\parallel^0}{\tau_0}\hat{\partial}_t\hat{A}_\parallel
%		- \frac{p_0}{\rho_0en_0\hat{n}_e}\hat{\grad}_\parallel \hat{p}_e 
%		- \frac{0.71T_0}{e\rho_0}\hat{\grad}_\parallel \hat{T}_e\right) \nonumber \\
%		&\Leftrightarrow&
%		\hat{\grad}\cdot\left[\hat{\grad}_\perp \hat{A}_\parallel\right]
%		&= \hat{\sigma}_\parallel\left(
%		\frac{\Phi_0}{B_0c_0\rho_0}\hat{\grad}_\parallel\hat{\Phi}
%		+ \frac{A_\parallel^0}{B_0c_0\tau_0}\hat{\partial}_t\hat{A}_\parallel
%		- \frac{p_0}{B_0c_0\rho_0en_0\hat{n}_e}\hat{\grad}_\parallel \hat{p}_e 
%		- \frac{0.71T_0}{B_0c_0e\rho_0}\hat{\grad}_\parallel \hat{T}_e\right) \nonumber \\
%		&\Leftrightarrow&
%		\hat{\grad}\cdot\left[\hat{\grad}_\perp \hat{A}_\parallel\right]
%		&= \hat{\sigma}_\parallel\left(
%		  \frac{\Phi_0\tau_0}{B_0\rho_0^2}\hat{\grad}_\parallel\hat{\Phi}
%		+ \frac{\mu_0en_0c_0\rho_0^2}{B_0c_0\tau_0}\hat{\partial}_t\hat{A}_\parallel
%		- \frac{p_0\tau_0}{B_0\rho_0^2en_0\hat{n}_e}\hat{\grad}_\parallel \hat{p}_e 
%		- \frac{0.71T_0\tau_0}{B_0e\rho_0^2}\hat{\grad}_\parallel \hat{T}_e\right) \nonumber \\
%		&\Leftrightarrow&
%		\hat{\grad}\cdot\left[\hat{\grad}_\perp \hat{A}_\parallel\right]
%		&= \hat{\sigma}_\parallel\left(
%     	  \frac{\Phi_0eB_0^2m_u}{eB_0^2T_0m_u}\hat{\grad}_\parallel\hat{\Phi}
%		+ \frac{\mu_0en_0\rho_0^2}{B_0\tau_0}\hat{\partial}_t\hat{A}_\parallel
%		- \frac{p_0eB_0^2m_u}{eB_0^2T_0m_uen_0\hat{n}_e}\hat{\grad}_\parallel \hat{p}_e 
%		- \frac{0.71T_0eB_0^2m_u}{B_0^2e^2T_0m_u}\hat{\grad}_\parallel \hat{T}_e\right) \nonumber \\
%		&\Leftrightarrow&
%		\hat{\grad}\cdot\left[\hat{\grad}_\perp \hat{A}_\parallel\right]
%		&= \hat{\sigma}_\parallel\left(
%		\frac{\Phi_0}{T_0}\hat{\grad}_\parallel\hat{\Phi}
%		+ \frac{\mu_0en_0\rho_0^2}{B_0\tau_0}\hat{\partial}_t\hat{A}_\parallel
%		- \frac{p_0}{T_0n_0e\hat{n}_e}\hat{\grad}_\parallel \hat{p}_e 
%		- \frac{0.71T_0}{eT_0}\hat{\grad}_\parallel \hat{T}_e\right) \nonumber \\
&\Leftrightarrow&
\hat{\grad}\cdot\left[\hat{\grad}_\perp \hat{A}_\parallel\right]
&= \hat{\sigma}_\parallel\left(
\hat{\grad}_\parallel\hat{\Phi}
+ \frac{\beta_0}{2}\hat{\partial}_t\hat{A}_\parallel
- \hat{T}_e\hat{\grad}_\parallel\log(\hat{n}_e)
- 1.71\hat{\grad}_\parallel \hat{T}_e\right) \nonumber		
\end{align}

Now, all components are available for a fully dedimensionalized version of the new system in \autoref{eq:vorticityEquation_electromagnetic}: 

\begin{align}
\label{eq:vorticityEquation_electromagnetic_dedimensionalized}
\begin{cases}
\hat{\grad}\cdot\left[\frac{\hat{m}_\alpha \hat{n}_\alpha}{ \hat{B}^2}\hat{\partial}_t\hat{\grad}_\perp\hat{\Phi}\right] + \hat{\grad}\cdot\left[\hat{\sigma}_\parallel\left(\hat{\grad}_\parallel\hat{\Phi}+ \frac{1}{2}\beta_0\hat{\partial}_t\hat{A}_\parallel\right)\mathbf{b}\right]
&= \hat{\grad}\cdot\left[\hat{\sigma}_\parallel\left(
\hat{T}_e\hat{\grad}_\parallel\log(\hat{n}_e) + 1.71\hat{\grad}_\parallel \hat{T}_e
\right)\mathbf{b}\right]-\hat{\partial}_t \hat{\Omega}_\pi \\
\qquad\qquad\quad-\hat{\grad}\cdot\left[\hat{\grad}_\perp \hat{A}_\parallel\right]
+ \hat{\sigma}_\parallel\left(\hat{\grad}_\parallel\hat{\Phi}
+ \frac{1}{2}\beta_0\hat{\partial}_t\hat{A}_\parallel\right) &= \hat{\sigma}_\parallel\left(
\hat{T}_e\hat{\grad}_\parallel\log(\hat{n}_e) + 1.71\hat{\grad}_\parallel \hat{T}_e
\right)
\end{cases}
\end{align}

It can also be compactly expressed in matrix form: 

\begin{align}
\renewcommand\arraystretch{1.8}
\begin{pmatrix}
\hat{\grad}\cdot\left[\frac{\hat{m}_\alpha \hat{n}_\alpha}{ \hat{B}^2}\hat{\partial}_t\hat{\grad}_\perp\circ\right] +  \hat{\grad}\cdot\left[\hat{\sigma}_\parallel\hat{\grad}_\parallel\circ\mathbf{b}\right] & 
\frac{1}{2}\beta_0\hat{\grad}\cdot\left[\hat{\sigma}_\parallel\hat{\partial}_t\circ\right]
\\
\hat{\sigma}_\parallel\hat{\grad}_\parallel\circ & 
\frac{1}{2}\beta_0\hat{\sigma}_\parallel\hat{\partial}_t\circ-\hat{\grad}\cdot\left[\hat{\grad}_\perp\circ\right]
\end{pmatrix}
\begin{pmatrix}
\hat{\Phi} \\ \hat{A}_\parallel
\end{pmatrix} 
\hspace{1.5cm}\nonumber \\ \label{eq:vorticityEquation_electromagnetic_dedimensionalized_matrix}\hspace{1.5cm}
= 
\begin{pmatrix}
\hat{\grad}\cdot\left[\hat{\sigma}_\parallel\left(
\hat{T}_e\hat{\grad}_\parallel\log(\hat{n}_e) + 1.71\hat{\grad}_\parallel \hat{T}_e
\right)\mathbf{b}\right]-\hat{\partial}_t \hat{\Omega}_\pi \\
\hat{\sigma}_\parallel\left(
\hat{T}_e\hat{\grad}_\parallel\log(\hat{n}_e) + 1.71\hat{\grad}_\parallel \hat{T}_e
\right)
\end{pmatrix}
\end{align}



\subsubsection{Electromagnetic vorticity system with electron inertia}
The last formulation of the vorticity equation that will be introduced in this chapter is the natural combination of the two precedent. We have a system over current density  $j_\parallel$ and the potential fields $\Phi$ and $A_\parallel$. 
%It might suggest itself to use the now available parallel current density in Ampère's law. For stability purposes however it is beneficial to include a term in $\partial_tA_\parallel$ so we again use a formulation alike in \autoref{eq:vorticityEquation_electromagnetic_dedimensionalized}, but with the electron inertia term in addition.
%
%\begin{equation}
%\label{eq:vorticityEquation_ElectronInertiaElectromagnetism_dedimensionalized_matrix}
%\begin{cases}
%\qquad\qquad\qquad\hat{\grad}\cdot\left[\frac{\hat{m}_\alpha \hat{n}_\alpha}{ \hat{B}^2}\hat{\partial}_t\hat{\grad}_\perp\hat{\Phi}\right] - \hat{\grad}\cdot\left[\hat{j}_\parallel \mathbf{b}\right]
% &= -\hat{\partial}_t \hat{\Omega}_\pi \\
%\qquad\qquad\quad\frac{1}{\hat{\sigma}_\parallel}\hat{j}_\parallel + \frac{m_e}{m_u\hat{n}} \hat{\partial}_t\hat{j}_\parallel + \hat{\grad}_\parallel\hat{\Phi} + \frac{1}{2}\beta_0\hat{\partial}_t\hat{A}_\parallel &= \hat{T}_e\hat{\grad}_\parallel\log(\hat{n}_e) + 1.71\hat{\grad}_\parallel \hat{T}_e \\
%- \hat{\grad}\cdot\left[\hat{\grad}_\perp \hat{A}_\parallel\right]  + \frac{1}{2}\beta_0\hat{\sigma}_\parallel\hat{\partial}_t\hat{A}_\parallel + \hat{\sigma}_\parallel\hat{\grad}_\parallel\hat{\Phi} + \frac{m_e\hat{\sigma}_\parallel}{m_u\hat{n}} \hat{\partial}_t\hat{j}_\parallel
% &= \hat{\sigma}_\parallel\left(\hat{T}_e\hat{\grad}_\parallel\log(\hat{n}_e) + 1.71\hat{\grad}_\parallel \hat{T}_e\right)
%\end{cases}
%\end{equation}
%
%In matrix form, this system reads:
%\begin{align}
%\renewcommand\arraystretch{1.8}
%\begin{pmatrix}
%\hat{\grad}\cdot\left[\frac{\hat{m}_\alpha \hat{n}_\alpha}{ \hat{B}^2}\hat{\partial}_t\hat{\grad}_\perp\circ\right]  & 
%-\hat{\grad}\cdot\left[\circ\mathbf{b}\right] & 
%0 \\
%\hat{\sigma}_\parallel\hat{\grad}_\parallel\circ &
%1 + \frac{m_e\hat{\sigma}_\parallel}{m_u\hat{n}}\hat{\partial}_t\circ &
%\frac{1}{2}\beta_0\hat{\sigma}_\parallel\hat{\partial}_t \\
%\hat{\sigma}_\parallel\hat{\grad}_\parallel\circ & 
%\frac{m_e\hat{\sigma}_\parallel}{m_u\hat{n}} \hat{\partial}_t\circ &
%\frac{1}{2}\beta_0\hat{\sigma}_\parallel\hat{\partial}_t\circ-\hat{\grad}\cdot\left[\hat{\grad}_\perp\circ\right]
%\end{pmatrix}
%\begin{pmatrix}
%\hat{\Phi} \\ \hat{j}_\parallel \\ \hat{A}_\parallel
%\end{pmatrix} 
%\hspace{1.5cm}\nonumber \\ \label{eq:vorticityEquation_ElectronInertiaElectromagnetism_dedimensionalized}\hspace{1.5cm}= 
%\begin{pmatrix}
%-\hat{\partial}_t \hat{\Omega}_\pi \\
%\hat{\sigma}_\parallel\left(\hat{T}_e\hat{\grad}_\parallel\log(\hat{n}_e) + 1.71\hat{\grad}_\parallel \hat{T}_e\right) \\
%\hat{\sigma}_\parallel\left(\hat{T}_e\hat{\grad}_\parallel\log(\hat{n}_e) + 1.71\hat{\grad}_\parallel \hat{T}_e\right)
%\end{pmatrix}
%\end{align}


It might suggest itself to use the now available parallel current density in Ampère's law. 
\begin{equation}
\label{eq:vorticityEquation_ElectronInertiaElectromagnetism_dedimensionalized_matrix}
\begin{cases}
\qquad\qquad\qquad\hat{\grad}\cdot\left[\frac{\hat{m}_\alpha \hat{n}_\alpha}{ \hat{B}^2}\hat{\partial}_t\hat{\grad}_\perp\hat{\Phi}\right] - \hat{\grad}\cdot\left[\hat{j}_\parallel \mathbf{b}\right]
&= -\hat{\partial}_t \hat{\Omega}_\pi \\
\frac{1}{\hat{\sigma}_\parallel}\hat{j}_\parallel + \frac{m_e}{m_u\hat{n}} \left(\hat{\partial}_t\hat{j}_\parallel - \hat{\grad}\cdot\hat{\nu}_e\hat{\grad}_\perp\hat{j}_\parallel\right)+ \hat{\grad}_\parallel\hat{\Phi} + \frac{1}{2}\beta_0\hat{\partial}_t\hat{A}_\parallel &= \hat{T}_e\hat{\grad}_\parallel\log(\hat{n}_e) + 1.71\hat{\grad}_\parallel \hat{T}_e + \frac{m_e}{m_u}\hat{D}_{\perp,u_i} \\
\qquad\qquad\qquad\qquad\qquad\qquad\qquad\quad\hat{\grad}\cdot\left[\hat{\grad}_\perp \hat{A}_\parallel\right] + \hat{j}_\parallel
&= 0
\end{cases}
\end{equation}

In matrix form, this final system reads:
\begin{align}
\renewcommand\arraystretch{1.8}
\begin{pmatrix}
\hat{\grad}\cdot\left[\frac{\hat{m}_\alpha \hat{n}_\alpha}{ \hat{B}^2}\hat{\partial}_t\hat{\grad}_\perp\circ\right]  & 
-\hat{\grad}\cdot\left[\circ\mathbf{b}\right] & 
0 \\
\hat{\sigma}_\parallel\hat{\grad}_\parallel\circ &
1 + \frac{m_e\hat{\sigma}_\parallel}{m_u\hat{n}}\left(\hat{\partial}_t\circ - \hat{\grad}\cdot\hat{\nu}_e\hat{\grad}_\perp\circ\right) &
\frac{1}{2}\beta_0\hat{\sigma}_\parallel\hat{\partial}_t \\
0 & 1 & \hat{\grad}\cdot\left[\hat{\grad}_\perp\circ\right]
\end{pmatrix}
\begin{pmatrix}
\hat{\Phi} \\ \hat{j}_\parallel \\ \hat{A}_\parallel
\end{pmatrix}  \hspace{1.5cm}\nonumber\\ = \hspace{3.5cm}
\begin{pmatrix}
-\hat{\partial}_t \hat{\Omega}_\pi \\
\hat{\sigma}_\parallel\left(\hat{T}_e\hat{\grad}_\parallel\log(\hat{n}_e) + 1.71\hat{\grad}_\parallel \hat{T}_e + \frac{m_e}{m_u}\hat{D}_{\perp,u_i}\right) \\
0
\end{pmatrix} \label{eq:vorticityEquation_ElectronInertiaElectromagnetism_dedimensionalized}
\end{align} 





\section{Boundary conditions}
\label{sec:S3X_boundaryConditions}

Boundary conditions are required at the tokamak wall and at the core edge boundary. They need to be defined in both parallel and perpendicular directions to the magnetic field lines. \newline
- In the perpendicular direction, zero Neumann boundary conditions for all plasma variables, i.e., $\partial_{\perp} (.)=0$, are imposed both at the wall and the core edge boundary except for the electromagnetic potential, which is fixed to $A_\parallel=0$ at the two radial boundaries. \newline
- In the parallel direction, boundary conditions are derived from the generalized Bohm-Chodura sheath boundary conditions \cite{Stangeby_2000}. They model the physics of the sheath located next to the limiter wall, where many assumptions used to derive the fluid models (quasi-neutrality, drift-ordering) are no longer valid. They can be expressed as: \newline

\begin{itemize}
	\item $|\boldsymbol{v}\cdot \boldsymbol{n}_\text{wall} | \ge | c_s \boldsymbol{b}\cdot \boldsymbol{n}_\text{wall} |$ with $\boldsymbol{n}_\text{wall}$ being the outward normal to the wall, meaning that the outgoing velocity normal to the wall is larger than the parallel sound speed normal to the wall. This property guarantees that the total plasma velocity is oriented outward.
	\item $\phi_{\mathcal{E},se} =  \gamma T \phi_{n,se}$. For each species, $\phi_{\mathcal{E},se}$ is the total energy flux at the sheath entrance, $\phi_{n,se}$ is the particle flux at the sheath entrance, and $\gamma$ is the sheath transmission factor equal to $2.5$ for ions and $4.5$ for electrons.
	\item $j_\text{wall} = \left[1 - \exp\left( \Lambda - \frac{\phi}{T_e} \right) \right] \phi_{n,se}$ is the total plasma current on the wall. The ion saturation current is computed from ion particle fluxes $\phi_{n,se}$, and $\Lambda$ denotes the normalized potential drop in the sheath with $\Lambda \sim 3$.
	\item $A_{\parallel}=0$ at the magnetic pre-sheath entrance.
\end{itemize}






